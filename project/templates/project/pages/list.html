{% extends "index.html" %}

{% load static %}
{% load sri %}

{% block pagetitle %}
Mes diagnostics
{% endblock pagetitle %}

{% block content %}
<div class="fr-container">
    <div class="d-flex justify-content-between align-items-center fr-mb-2w">
        <h1>Mes diagnostics</h1>
        <div class="fr-search-bar" id="header-search" role="search">
            <input class="fr-input" placeholder="Rechercher" type="search" id="filter-diagnostic-list-input">
            <button class="fr-btn" title="Rechercher"></button>
         </div>
    </div>
    <div class="fr-grid-row fr-grid-row--gutters">
        {% for project in projects %}

        <div class="fr-col-12 fr-col-md-12 diagnostic-list-item">
            <div class="fr-card fr-card--horizontal fr-card--sm">
                <div class="fr-card__body">
                    <div class="fr-card__content fr-pb-1w">
                        <div class="fr-card__title d-flex justify-content-between align-items-center">
                            <h3 class="diagnostic-list-item-key fr-mb-0" data-key="{{ project.territory_name }}">
                                {{ project.territory_name }}
                            </h3>
                            <p class="fr-badge fr-badge--sm fr-badge--search">{{ project.get_land_type_display }}</p>
                        </div>
                        <div class="fr-card__end fr-mt-0">
                            <ul class="fr-badges-group">
                                <li>
                                    <p class="fr-badge fr-badge--sm fr-badge--green-emeraude">
                                        <span class="bi bi-bullseye fr-mr-1v" aria-hidden="true"></span>
                                        Maille d'analyse: {{ project.level_label }}
                                    </p>
                                </li>
                                <li>
                                    <p class="fr-badge fr-badge--sm fr-badge--purple-glycine">
                                        <span class="bi bi-bounding-box-circles fr-mr-1v" aria-hidden="true"></span>
                                        {{ project.area|floatformat:0 }} ha
                                    </p>
                                </li>
                            </ul>
                        </div>
                    </div>
                    <div class="fr-card__footer">
                        <div class="d-flex">
                            <a href="{% url 'project:home' project.id %}" class="fr-mr-2w fr-link--text-decoration-none">
                                <button class="fr-btn fr-btn--primary fr-btn--icon-right fr-btn--sm fr-icon-arrow-right-line">
                                    Accéder au diagnostic
                                </button>
                            </a>
                            <a href="{% url 'project:report_target_2031' project.id %}" class="fr-link--text-decoration-none">
                                <button class="fr-btn fr-btn--primary fr-btn--icon-right fr-btn--sm fr-icon-arrow-right-line">
                                    Simuler une trajectoire de sobriété foncière
                                </button>
                            </a>
                        </div>
                        {% if project.report_drafts.all %}
                        <div class="fr-mt-3w">
                            <section class="fr-accordion">
                                <h3 class="fr-accordion__title">
                                    <button type="button" class="fr-accordion__btn fr-text--sm" aria-expanded="false" aria-controls="accordion-{{ project.id }}">
                                        Rapports téléchargeables ({{ project.report_drafts.count }})
                                    </button>
                                </h3>
                                <div class="fr-collapse" id="accordion-{{ project.id }}">
                                    <ul class="fr-list">
                                        {% for draft in project.report_drafts.all %}
                                        <li>
                                            <a href="{% url 'project:report_downloads_draft' project.id draft.id %}" class="fr-text--sm">
                                                {{ draft.name }} ({{ draft.get_report_type_display }})
                                            </a>
                                        </li>
                                        {% endfor %}
                                    </ul>
                                </div>
                            </section>
                        </div>
                        {% endif %}
                    </div>
                </div>
            </div>
        </div>
        {% empty %}
        <p class="text-muted">Vous n'avez aucun diagnostic.</p>
        {% endfor %}
    </div>
    <p id="diagnostic-list-empty-message" hidden>Il n'y a aucun diagnostic correspondant à votre recherche.</p>
</div>
{% endblock content %}

{% block bodyend %}
<script nonce="[NONCE_PLACEHOLDER]">
    const filterDiagnosticListInput = document.getElementById('filter-diagnostic-list-input')

    if (filterDiagnosticListInput) {
        filterDiagnosticListInput.onkeyup = () => {
            const keyword = filterDiagnosticListInput.value.toLowerCase()
            let elements = document.querySelectorAll('.diagnostic-list-item')
            elements = Array.from(elements)

            elements.forEach((element) => {
                const name = element.querySelector('.diagnostic-list-item-key').dataset.key.toLowerCase()
                if (name.indexOf(keyword) !== -1) {
                    element.removeAttribute('hidden')
                    element.style.visibility = 'visible'
                }
                else {
                    element.setAttribute('hidden', true)
                    element.style.visibility = 'hidden'
                }
            })

            // Get hidden elements count
            const emptyMessage = document.getElementById('diagnostic-list-empty-message')
            if (elements.length === elements.filter((obj) => obj.hidden).length) {
                emptyMessage.removeAttribute('hidden')
                emptyMessage.style.visibility = 'visible'
            }
            else {
                emptyMessage.setAttribute('hidden', true)
                emptyMessage.style.visibility = 'hidden'
            }
        }
    }
</script>
{% endblock bodyend %}
