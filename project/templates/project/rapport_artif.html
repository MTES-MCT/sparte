{% extends 'index.html' %}

{% load static %}
{% load project_tags %}
{% load humanize %}
{% load i18n %}
{% load l10n %}
{% load highcharts_tags %}
{% load sri %}

{% block pagetitle %}
Rapport artificialisation
{% endblock %}

{% block headers %}
{% sri_static "project/css/project.css" %}
{% endblock %}

{% block content %}
<div class="px-4">
    {% include "project/partials/report_title.html" with title=diagnostic surface=diagnostic.area %}

    {% include "project/detail_menu.html" %}

    <div class="fr-container fr-py-3w">
        {% include "project/partials/report_informations.html" with content=information_artif_1 id="artif_1" %}

        <div class="fr-mt-7w">
            <div class="fr-grid-row fr-grid-row--gutters">
                <div class="fr-col-12 fr-col-md-4 fr-grid-row">
                    <div class="fr-callout w-100">
                    <p class="fr-callout__title">{{ total_surface|floatformat:0 }} ha</p>
                    <p>Surface du territoire</p>
                    </div>
                </div>
                <div class="fr-col-12 fr-col-md-4 fr-grid-row">
                    <div class="fr-callout w-100">
                    <p class="fr-callout__title">{{ artif_area|floatformat:0 }} ha</p>
                    <p><span class="dotted" data-toggle="tooltip" title="Surface des zones artificielles, c'est-à-dire les espaces répondant à la définition de la loi Climat et Résilience et à ses décrets d'application à une date donnée." aria-hidden="true">Surfaces artificialisées</span> en {{ last_millesime }}</p>
                    </div>
                </div>
                <div class="fr-col-12 fr-col-md-4 fr-grid-row">
                    <div class="fr-callout w-100">
                    <p class="fr-callout__title">{{ rate_artif_area|floatformat:0 }}%</p>
                    <p>Taux de surfaces artificialisées</p>
                    </div>
                </div>
            </div>
        </div>

        <div class="fr-mt-12w">
            <h2>Evolution en volume sur la période de {{ diagnostic.analyse_start_date }} à {{ diagnostic.analyse_end_date }}</h2>
            <p>Sur la période demandée, l'OCS GE couvre de {{ first_millesime }} à {{ last_millesime }}.</p>
            <div class="fr-grid-row fr-grid-row--gutters">
              <div class="fr-col-12 fr-col-md-6 fr-col-lg-3 fr-grid-row">
                <div class="fr-callout w-100">
                  <p class="fr-callout__title">{{ new_artif|floatformat:0 }} ha</p>
                  <p><span class="dotted" data-toggle="tooltip" title="C'est la mutation d'un espace entre deux dates qui le transforme de zone non artificielle en zone artificielle." aria-hidden="true">Artificialisation</span></p>
                </div>
              </div>
              <div class="fr-col-12 fr-col-md-6 fr-col-lg-3 fr-grid-row">
                <div class="fr-callout w-100">
                  <p class="fr-callout__title">{{ new_natural|floatformat:0 }} ha</p>
                  <p><span class="dotted" data-toggle="tooltip" title="C'est la mutation d'un espace entre deux dates qui le transforme de zone artificielle en zone non artificielle." aria-hidden="true">Renaturation</span></p>
                </div>
              </div>
              <div class="fr-col-12 fr-col-md-6 fr-col-lg-3 fr-grid-row">
                <div class="fr-callout w-100">
                  <p class="fr-callout__title">{{ net_artif|floatformat:0 }} ha</p>
                  <span class="dotted" data-toggle="tooltip" title="C'est la différence entre la somme des surfaces des zones artificialisées et renaturées entre deux dates." aria-hidden="true">Artificialisation nette</span></p>
                </div>
              </div>
              <div class="fr-col-12 fr-col-md-6 fr-col-lg-3 fr-grid-row">
                <div class="fr-callout w-100">
                  <p class="fr-callout__title">{{ net_artif_rate|floatformat:0 }} %</p>
                  <p><span class="dotted" data-toggle="tooltip" title="C'est le rapport entre l'artificialisation nette et la surface des zones artificialisées." aria-hidden="true">Taux d'artificialisation nette</span></p>
                </div>
              </div>
            </div>
        </div>

        <div class="fr-mt-12w">
            <div class="fr-grid-row fr-mb-2w">
                <h3 class="fr-col-12 fr-col-lg-8" id="conso-annuelle">Consommation annuelle des {% if level == "COMM" %}communes{% elif level == "EPCI" %}communes{% elif level == "DEPT" %}EPCI{% else %}départements{% endif %} du territoire</h3>
                <div class="fr-col-12 fr-col-lg-4">
                    <div class="d-flex justify-content-end align-items-center">
                        <div class="dropdown custom-dropdown fr-mr-2w">
                            <button class="fr-btn fr-btn--tertiary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill" data-bs-toggle="dropdown" aria-expanded="false">
                                Maille d'analyse
                            </button>
                          
                            <ul class="dropdown-menu">
                                <li>
                                    <a class="fr-nav__link" {% if level == "COMM" %} aria-current="true"{% endif %} href="{% url "project:report_artif" project.id %}?level_conso=COMMUNE">Communes</a>
                                </li>
                                {% if land_type in "DEPART_REGION_COMP" %}
                                <li>
                                    <a class="fr-nav__link" {% if level == "EPCI" %} aria-current="true"{% endif %} href="{% url "project:report_artif" project.id %}?level_conso=EPCI">EPCI</a>
                                </li>
                                {% endif %}
                                {% if land_type in "REGION_COMP" %}
                                <li>
                                    <a class="fr-nav__link" {% if level == "DEPART" %} aria-current="true"{% endif %} href="{% url "project:report_artif" project.id %}?level_conso=DEPART">Départements</a>
                                </li>
                                {% endif %}
                                {% if land_type in "COMP" %}
                                <li>
                                    <a class="fr-nav__link" {% if level == "REGION" %} aria-current="true"{% endif %} href="{% url "project:report_artif" project.id %}?level_conso=REGION">Régions</a>
                                </li>
                                {% endif %}
                            </ul>
                        </div>
                    </div>
                </div>
            </div>

            <div id="chart_comparison" class="border fr-p-3w fr-pt-5w"></div>

            <div class="fr-callout bg-white fr-p-2w mt-4">
                <button class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill mt-0" aria-expanded="false" aria-controls="target-data-1">Données</button>
                <div class="fr-collapse" id="target-data-1">
                    <h6 class="fr-mt-2w">Source</h6>
                    <p>Données d'OCcupation des Sols à Grande Echelle (OCS GE) de l'IGN, sur la période d'analyse.</p>

                    <h6 class="fr-mt-2w">Calcul</h6>
                    <p>OCS GE traduite grâce à la matrice de passage.</p>
 
                    <h6 class="fr-mt-2w">Données</h6>
                    <table class="table table-striped table-sm table-borderless mt-5">
                        <thead>
                            <tr>
                                <th scope="col"></th>
                                {% for period in headers_evolution_artif %}
                                <th scope="col" class="text-end">{{ period }}</th>
                                {% endfor %}
                                <th scope="col" class="text-end">Total</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for serie_name, data in table_comparison.items %}
                            <tr>
                                <th scope="row">{{ serie_name }}</th>
                                {% for period, val in data.items %}
                                <td align="right">{{ val|floatformat:1 }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="fr-mt-12w">
            <h3>Evolution</h3>

            <div id="chart_waterfall" class="border fr-p-3w fr-pt-5w"></div>

            <div class="fr-callout bg-white fr-p-2w mt-4">
                <button class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill mt-0" aria-expanded="false" aria-controls="target-data-2">Données</button>
                <div class="fr-collapse" id="target-data-2">
                    <h6 class="fr-mt-2w">Source</h6>
                    <p>Données d'OCcupation des Sols à Grande Echelle (OCS GE) de l'IGN, sur la période d'analyse traduite grâce à la matrice de passage.</p>

                    <h6 class="fr-mt-2w">Calcul</h6>
                    <p>Artificialisation sur la période - renaturation sur la période.</p>

                    <h6 class="fr-mt-2w">Données</h6>
                    <table class="table table-striped table-sm table-borderless">
                        <thead>
                            <tr>
                                <th scope="col"></th>
                                {% for period in headers_evolution_artif %}
                                <th scope="col" class="text-end">{{ period }} (Ha)</th>
                                {% endfor %}
                                <th scope="col" class="text-end">Total (Ha)</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for serie_name, data in table_evolution_artif.items %}
                            <tr>
                                <th scope="row">{{ serie_name }}</th>
                                {% for period, val in data.items %}
                                <td align="right">{{ val|floatformat:1 }}</td>
                                {% endfor %}
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>

        <div class="fr-mt-12w">
            <h3>Détail de l'artificialisation :</h3>

            <div class="border fr-p-3w fr-grid-row graph-group-container">
                <div class="fr-col-12 fr-col-lg-4">
                    <div id="couv_artif_sol"></div>
                </div>
                <div class="fr-col-12 fr-col-lg-4">
                    <div id="usage_artif_sol"></div>
                </div>
                <div class="fr-col-12 fr-col-lg-4">
                    <div id="detail_artif_chart"></div>
                </div>
            </div>

            <div class="fr-callout bg-white fr-p-2w mt-4">
                <button class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill mt-0" aria-expanded="false" aria-controls="target-data-3">Données</button>
                <div class="fr-collapse" id="target-data-3">
                    <h6 class="fr-mt-2w">Source</h6>
                    <p>données d'OCcupation des Sols à Grande Echelle (OCS GE) de l'IGN, sur la période d'analyse (millésime min : 2013, millésime max : 2019).</p>

                    <h6 class="fr-mt-2w">Calcul</h6>
                    <p>OCS GE traduite grâce à la matrice de passage.</p>

                    <h6 class="fr-mt-2w">Données</h6>
                    <p>En hectare (Ha).</p>
                    <table class="table table-striped table-sm table-borderless">
                        <thead>
                            <tr>
                                <th scope="col"></th>
                                <th scope="col" class="text-end">Artificialisation</th>
                                <th scope="col" class="text-end" class="text-muted">%</th>
                                <th scope="col" class="text-end">renaturation</th>
                                <th scope="col" class="text-end" class="text-muted">%</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for couv in detail_artif_chart.get_series %}
                            <tr>
                                <th scope="row">{{ couv.code_prefix }} {{ couv.label }}</th>
                                <td align="right">{{ couv.artif|floatformat:1 }}</td>
                                <td align="right" class="text-muted">{{ couv.artif|percent:detail_total_artif }}</td>
                                <td align="right">{{ couv.renat|floatformat:1 }}</td>
                                <td align="right" class="text-muted">{{ couv.renat|percent:detail_total_renat }}</td>
                            </tr>
                            {% endfor %}
                            <tr>
                                <th scope="row" class="text-muted">Total :</th>
                                <td align="right" class="text-muted">{{ detail_total_artif|floatformat:1 }}</td>
                                <td align="right" class="text-muted">100%</td>
                                <td align="right" class="text-muted">{{ detail_total_renat|floatformat:2 }}</td>
                                <td align="right" class="text-muted">100%</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block bodyend %}
{% localize off %}
{% sri_static "highcharts/js/highcharts.js" %}
{% sri_static "highcharts/js/highcharts-more.js" %}
{% sri_static "highcharts/js/exporting.js" %}
{% french_translation %}
{% display_chart 'detail_artif_chart' detail_artif_chart CSP_NONCE %}
{% display_chart 'couv_artif_sol' couv_artif_sol CSP_NONCE %}
{% display_chart 'usage_artif_sol' usage_artif_sol CSP_NONCE %}
{% display_chart 'chart_comparison' chart_comparison CSP_NONCE %}
{% display_chart 'chart_waterfall' chart_waterfall CSP_NONCE %}
{% endlocalize %}
{% endblock %}

{% block tagging %}
<script language="javascript" nonce="{{ CSP_NONCE }}">
$( window ).on('load', function () {
    _paq.push(['trackEvent', 'Consultation diagnostic', 'Tableau de bord', 'Artificialisation'])
})

var fired = false
$( window ).scroll(function() {
    if(fired == false && $( window ).scrollTop() + $( window ).height() > $( "#block-content" ).height() - 100) {
        _paq.push(['trackEvent', 'Consultation diagnostic', 'Fin tableau de bord', 'Artificialisation'])
        fired = true
    }
})
</script>
{% endblock tagging %}
