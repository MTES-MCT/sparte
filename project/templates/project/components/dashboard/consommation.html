{% load highcharts_tags %}
{% load sri %}

 <div class="fr-grid-row fr-grid-row--gutters">
    <div class="fr-col-12 fr-col-md-6 fr-grid-row">
        {% include "project/components/widgets/statistic.html" with title=total_surface|floatformat:0|add:" ha" description="Surface du territoire" %}
    </div>
    <div class="fr-col-12 fr-col-md-6 fr-grid-row">
        {% include "project/components/widgets/statistic.html" with title=conso_period|floatformat:2|add:" ha" description="Consommation d'espaces NAF de "|add:project.analyse_start_date|add:" à "|add:project.analyse_end_date %}
    </div>
</div>

<div class="fr-mt-5w">
    <h3 id="conso-annuelle">Consommation d'espace annuelle sur le territoire</h3>

    <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12">
            <div class="bg-white fr-p-2w h-100">
                <div class="d-flex justify-content-end align-items-center fr-mb-2w">
                    {% include "project/components/widgets/chart_buttons.html" with chart="annual_total_conso_chart" show_fullscreen=True %}
                    <button class="fr-btn fr-icon-question-line fr-btn--tertiary fr-btn--sm" data-bs-toggle="modal" data-bs-target="#consoAnnuelle" data-toggle="tooltip" title="Astuces pour lire le graphique"></button>
                </div>
                <div id="annual_total_conso_chart"></div>
            </div>
        </div>
    </div>

    <div class="fr-notice bg-white fr-mt-2w">
        <div class="fr-px-2w">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <span class="fr-icon-information-line" aria-hidden="true"></span>
                    <span class="fr-text--xs fr-mr-1w">Source de données: </span>
                    <p class="fr-tag fr-tag--sm fr-tag--blue">
                        <strong>FICHIERS FONCIERS</strong>
                    </p>
                </div>
                <button class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill mt-0" aria-expanded="false" aria-controls="target-data-1">Détails données et calcul</button>
            </div>
            <div class="fr-collapse" id="target-data-1">
                <h6 class="fr-mt-2w">Source</h6>
                {% include "project/components/widgets/source_majic.html" %}
                <h6 class="fr-mt-2w">Calcul</h6>
                <p class="fr-text--sm">Données brutes, sans calcul</p>

                <h6 class="fr-mt-2w">Données</h6>
                <div class="fr-table fr-table--bg-whiteed">
                    <div class="fr-table__wrapper">
                        <div class="fr-table__container">
                            <div class="fr-table__content">
                                <table class="table-last-column-bold table-last-row-bold">
                                    <caption>
                                        Consommation d'espace annuelle sur le territoire (en ha)
                                    </caption>
                                    <thead>
                                        <tr>
                                            <th scope="col" class="fr-cell--fixed"></th>
                                            {% for year in project.years %}
                                            <th scope="col" class="fr-cell--right">{{ year }}</th>
                                            {% endfor %}
                                            <th scope="col" class="fr-cell--right">Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item, data in annual_conso_data_table.items %}
                                        <tr>
                                            <th scope="row" class="fr-cell--fixed">{{ item }}</th>
                                            {% for year, val in data.items %}
                                            <td class="fr-cell--right">+{{ val|floatformat:1 }}</td>
                                            {% endfor %}
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    {% if not is_commune %}
    <div class="fr-grid-row fr-grid-row--gutters fr-mt-2w">
        <div class="fr-col-12">
            <div class="bg-white fr-p-2w">
                {% url 'project:theme-city-conso' project.pk as map_url %}
                {% include "project/components/map/iframe_map.html" with src=map_url title="Carte consommation d'espaces des communes du territoire sur la période (en %)" %}
            </div>
        </div>
    </div>
    {% endif %}
</div>

<div class="fr-mt-7w">
    <h3 id="determinants-conso">Destinations de la consommation d'espace</h3>

    <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-lg-4">
            <div class="bg-white fr-p-2w">
                <div class="d-flex justify-content-end align-items-center fr-mb-2w">
                    {% include "project/components/widgets/chart_buttons.html" with chart="pie_determinant" show_fullscreen=True %}
                    <button class="fr-btn fr-icon-question-line fr-btn--tertiary fr-btn--sm" data-bs-toggle="modal" data-bs-target="#determinantModal" data-toggle="tooltip" title="Astuces pour lire le graphique"></button>
                </div>
                <div id="pie_determinant"></div>
            </div>
        </div>
        <div class="fr-col-12 fr-col-lg-8">
            <div class="bg-white fr-p-2w">
                <div class="d-flex justify-content-end align-items-center fr-mb-2w">
                    {% include "project/components/widgets/chart_buttons.html" with chart="chart_determinant" show_fullscreen=True %}
                    <button class="fr-btn fr-icon-question-line fr-btn--tertiary fr-btn--sm" data-bs-toggle="modal" data-bs-target="#determinantModal" data-toggle="tooltip" title="Astuces pour lire le graphique"></button>
                </div>
                <div id="chart_determinant"></div>
            </div>
        </div>
    </div>

    <div class="fr-notice bg-white fr-mt-2w">
        <div class="fr-px-2w">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <span class="fr-icon-information-line" aria-hidden="true"></span>
                    <span class="fr-text--xs fr-mr-1w">Source de données: </span>
                    <p class="fr-tag fr-tag--sm fr-tag--blue">
                        <strong>FICHIERS FONCIERS</strong>
                    </p>
                </div>
                <button class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill mt-0" aria-expanded="false" aria-controls="target-data-3">Détails données et calcul</button>
            </div>
            <div class="fr-collapse" id="target-data-3">
                <h6 class="fr-mt-2w">Source</h6>
                {% include "project/components/widgets/source_majic.html" %}
                <p class="fr-text--sm">
                    La ligne "inconnu" comprend les éléments dont la destination
                    n’est pas définie dans les fichiers fonciers.
                </p>
                <h6 class="fr-mt-2w">Calcul</h6>
                <p class="fr-text--sm">Données brutes, sans calcul</p>

                <h6 class="fr-mt-2w">Données</h6>
                {{ determinant_data_table }}
            </div>
        </div>
    </div>
</div>

<div class="fr-mt-7w">
    <h3 id="determinants-conso">Consommation d'espace et démographie</h3>

    <div class="fr-grid-row fr-grid-row--gutters">
        <div class="fr-col-12 fr-col-lg-8">
            <div class="fr-grid-row fr-grid-row--gutters">
                <div class="fr-col-12 fr-col-md-6 fr-grid-row">
                    <div class="fr-callout bg-white w-100">
                        <p class="fr-callout__title">{% if population_evolution > 0 %}+{% endif %} {{ population_evolution|floatformat:0 }}</p>
                        <p>Habitant{{ population_evolution|pluralize }} sur la période</p>
                    </div>
                </div>
                <div class="fr-col-12 fr-col-md-6 fr-grid-row">
                    <div class="fr-callout bg-white w-100">
                        <p class="fr-callout__title">{{ conso_period|floatformat:2 }} ha</p>
                        <p>D'espaces NAF consommés sur la période</p>
                    </div>
                </div>
            </div>
            <div class="bg-white fr-p-2w">
                <div class="d-flex justify-content-end align-items-center fr-mb-2w">
                    {% include "project/components/widgets/chart_buttons.html" with chart="population_density_chart" show_fullscreen=false %}
                    <button class="fr-btn fr-icon-question-line fr-btn--tertiary fr-btn--sm" data-bs-toggle="modal" data-bs-target="#densityModal" data-toggle="tooltip" title="Astuces pour lire le graphique"></button>
                </div>
                <div id="population_density_chart"></div>
            </div>
        </div>

        <div class="fr-col-12 fr-col-lg-4">
            <div class="guide-container guide-container--column h-100">
                <svg  class="guide-icon" version="1.0" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 512 512" style="fill: #48d5a7;"><path d="M247.5 4.5c-3 2.9-3.2 6.4-.4 9.8l2 2.7 109.7.2 109.7.3 5.3 2.2c10.8 4.4 18.7 13.5 21.7 24.8 1.2 4.9 1.5 13.8 1.5 53.8v47.8l2.6 2.6c2 2 3.1 2.4 5.7 1.9 6.9-1.3 6.7.6 6.7-53.7 0-31.3-.4-50.7-1.1-54.1-3.9-19-20.7-35.8-39.7-39.7C467.6 2.3 432 2 357.9 2h-108zm-29 .8c-9.6 3.8-18.2 10.5-23.6 18.4l-3 4.3-74.7.2-74.7.3-5.1 2.7C30.9 34.6 24 42.3 21.7 48.6c-1.6 4.6-1.7 13.5-1.5 149.9l.3 145 2.7 5.1c1.5 2.8 4.9 7.1 7.6 9.5l4.8 4.3-17.5 27C3.1 412.6.6 417 .3 420.9c-.4 5.2 2.3 11 6.9 14.4 3.7 2.8 11.6 3.4 15.8 1.2 1.8-.9 23.7-17.2 48.7-36.1 39.3-29.8 45.8-34.4 48.8-34.4h3.5v34.8c0 34.6 0 34.9 2.3 39.3 1.3 2.4 4.3 5.7 6.6 7.4l4.3 3 89.8.3 89.7.2 12.4 26.8c6.8 14.7 13.5 27.9 15 29.4 5 5.1 11 4.9 16.6-.7l3.3-3.3V451h7.3c8.6 0 13.8-2.1 18.4-7.3 1.8-2 3.7-5.3 4.2-7.4.7-2.5 1.1-25.8 1.1-66.5v-62.7l39.8 30.2c21.8 16.5 41.3 30.9 43.2 31.9 7.3 3.8 16.6.6 20.8-7.3s3.5-9.7-14.8-37.9c-8.9-13.8-16.1-25.2-15.9-25.4s3.1-1.1 6.4-2.1c16.4-4.7 28-15.4 34.6-32 2.4-6 2.4-6.3 2.7-49.7l.3-43.8-2.5-2.5c-3-3-6.4-3.2-9.9-.5l-2.6 2.1-.3 42.7-.3 42.7-3.1 6.5c-3.8 8-10.1 14.5-17.4 17.9l-5.5 2.6-119 .3c-65.5.1-120.5 0-122.2-.3l-3.3-.6-.2-115.2c-.3-109.8-.4-115.4-2.2-119.2-2.4-5.3-7.9-12-11.6-14.2-1.7-.9-3-2.1-3-2.6 0-1.7 6.8-7 13.2-10.3 4.9-2.5 6.9-4.1 7.4-5.9 1-3.9-.4-7.3-3.6-9-3.4-1.7-3.5-1.7-7.5-.2m-18.2 39.1c4.2 1.7 8.3 6.6 9.7 11.4 1.4 5.1 1.4 277.3 0 282.4-1.4 4.8-5.5 9.7-9.7 11.4-2.6 1.1-17 1.4-77.6 1.4H48.4l-4.4-2.3c-3-1.4-5.3-3.6-6.7-6.2l-2.3-4v-283l2.3-4c1.4-2.6 3.7-4.8 6.7-6.3l4.4-2.2h74.3c60.6 0 75 .3 77.6 1.4M308.6 299H379v67.5c0 65.6-.1 67.5-1.9 68.5-1.3.7-39.9 1-117.8 1-103.2 0-116.1-.2-118.1-1.6-2.2-1.5-2.2-1.5-2.2-35V366h30.5c28.7 0 30.8-.1 36.2-2.1 9.8-3.7 18-13.9 19.8-24.7l.7-4.2H288c60.9 0 61.8 0 64.4-2.1 3.4-2.7 3.6-7.9.4-10.9-2.1-2-3.2-2-64.5-2H226v-22.3l6.1.7c3.4.3 37.9.6 76.5.6M465 322.7c8.5 13.1 16.5 25.5 17.8 27.6 3.1 4.7 2.4 5.6-2 2.5-3.1-2.1-52.8-39.7-65.5-49.6l-5.5-4.2h39.9zM88 368.8c-18.5 14.7-71.6 53.9-71.8 53.2-.2-.6 7-12.4 16-26.2 8.9-13.8 17-26.1 17.8-27.4 1.5-2.4 1.5-2.4 21.5-2.4h20zm261 98.4c0 8.9-.2 15.9-.4 15.7-.6-.5-14.6-30.9-14.6-31.5 0-.2 3.4-.4 7.5-.4h7.5z"/><path d="M72 129.5c-7.5 2.2-13.6 5.9-17 10.6-5.7 7.9-4.6 16.6 2.3 18.8 4.6 1.5 7.4.3 11.6-4.9 4-4.9 8.3-7 14.7-7 9.7 0 15 4.8 14.1 12.8-.5 4.4-1.1 5.2-10.6 14.2-10.8 10.2-13.3 14.3-14.6 23.6-.8 6.2.8 13 3.5 14.4 4 2.1 12.1.7 14.2-2.4.4-.6.8-2.9.8-5.1 0-8.4 1.7-11.4 11.5-20.8 10.9-10.4 15.4-17.8 16.2-26.6 1-11.1-6.4-21.6-18.6-26.2-7.4-2.8-20.6-3.5-28.1-1.4m75 0c-14.6 4.1-23.7 15.5-19.9 24.6 1.4 3.6 6.6 6.3 10.3 5.3 1.4-.3 4.3-2.7 6.5-5.4 4.8-5.7 9.1-7.4 16.6-6.8 6.7.6 11.2 3.7 12.1 8.3 1.1 6.2-.3 8.6-10.6 18.5-10.9 10.4-13.3 14.5-14.5 24.2-.8 6.5.7 12.3 3.5 13.8 4 2.1 12.1.7 14.2-2.4.4-.6.8-2.9.8-5.1 0-8.3 1.6-11.1 12.4-21.8 12.4-12.4 15-17 15-27.2 0-5.3-.5-8-2.1-11.1-3-5.6-9.4-10.9-16.2-13.5-7.4-2.8-20.6-3.4-28.1-1.4m-73.6 98.8c-6.4 5.8-5.5 15.2 1.9 19.7 8 4.9 18.7-.9 18.7-10.2 0-7.9-4.9-12.8-13-12.8-3.2 0-4.8.7-7.6 3.3m76.4-1.5c-5.6 3.4-7.3 11.2-3.8 16.9 3.8 6.3 11.2 8 17.1 4 5.8-3.9 7.6-10.6 4.4-16.7-2.9-5.7-12-7.8-17.7-4.2m15.3 149.8c-1.2 1.5-2.1 3.3-2.1 4 0 2.6 2.3 6.2 4.7 7.3 1.7.8 20.4 1.1 61.8 1.1h59.4l2.7-2.3c3.3-2.8 3.7-7.6.9-10.7-1.8-2-2.9-2-63.6-2h-61.8zM312 376c-2.5 2.5-2.6 7.1-.1 10.1 1.9 2.3 2.4 2.4 20 2.7l18.1.3 2.5-2.5c3.1-3.1 3.3-7.8.5-10.6-1.9-1.9-3.3-2-20.5-2s-18.6.1-20.5 2m20.9-341.6c-11.5 4.1-19.2 15.1-19.3 27.6 0 8.1 1.5 12.7 6.4 18.9 5.7 7.1 13.2 10.6 23 10.6 9 0 14.9-2.4 20.7-8.2 12.3-12.3 11.7-31.8-1.3-43.2-2.5-2.2-6.6-4.7-9.1-5.5-5.6-1.9-15.4-2-20.4-.2m16.7 15.2c9.4 4.5 9.9 19.1.8 25-3.5 2.3-11.3 2.3-14.8 0-4-2.6-6.6-7.5-6.6-12.5 0-10.7 10.7-17.2 20.6-12.5m-36.7 52.7c-5.6 3.7-6.9 7.6-6.9 20.5 0 7.3.5 12.4 1.4 14.6 1.5 3.5 6.3 7.6 9 7.6 1.4 0 1.6 3.8 1.6 37.5 0 37.1 0 37.5-2 37.5-2.9 0-7 2.3-10 5.5-2.4 2.5-2.5 3.3-2.8 17-.4 15.9.4 19.2 5.6 23 2.6 1.9 4.5 2 38.7 2.3 32.8.2 36.3.1 39.4-1.5 6.3-3.3 7.5-6.1 7.9-18.4.3-6 .1-12.9-.2-15.4-1-6.1-5.8-11.2-11.4-12.1l-4.2-.7v-55.6c0-53.8-.1-55.7-2-58.9-1.1-1.8-3.2-3.7-4.6-4.2-1.4-.6-14.3-1-29.3-1-26.2 0-26.9.1-30.2 2.3m51.1 68.8c0 39.3.3 56.7 1.1 58.2 1.9 3.8 5.2 5.7 9.7 5.7h4.2v18h-61v-18h3.1c4 0 8.2-2.5 10.5-6.4 1.8-2.9 1.9-5.7 1.9-45.6 0-48.5.2-47.5-8.1-51.1l-4.4-2V115h43z"/></svg>
                <div class="guide-content">
                    <div class="guide-title">Comprendre les données</div>
                    <div class="guide-description">
                        <p class="fr-text--sm">
                            Sur la période {{ project.analyse_start_date }}-{{ project.analyse_end_date }},
                            le territoire de {{ project.territory_name }}
                            <strong>
                            {% if population_evolution == 0 %}
                                n'a gagné aucun habitant,
                            {% else %}
                                {% if population_evolution > 0 %}
                                    a gagné {{ population_evolution|floatformat:0 }} habitant{{ population_evolution|pluralize }},
                                {% else %}
                                    a perdu {{ population_evolution_abs|floatformat:0 }} habitant{{ population_evolution_abs|pluralize }},
                                {% endif %}
                            {% endif %}
                            </strong>soit une évolution de {{ population_evolution_percent|floatformat:2 }}%.
                        </p>
                        <p class="fr-text--sm"> 
                            Sur cette même période,
                            <strong>{{ consommation_total|floatformat:2 }} ha d'espaces NAF ont été consommés</strong>, soit {{ consommation_total_percent|floatformat:2 }}% du territoire.
                        </p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="fr-mt-5w">
    <div class="bg-white fr-p-2w">
        <div class="d-flex justify-content-end align-items-center fr-mb-2w">
            {% include "project/components/widgets/chart_buttons.html" with chart="population_conso_progression_chart" show_fullscreen=True %}
            <button class="fr-btn fr-icon-question-line fr-btn--tertiary fr-btn--sm" data-bs-toggle="modal" data-bs-target="#populationConsoProgressionModal" data-toggle="tooltip" title="Astuces pour lire le graphique"></button>
        </div>
        <div id="population_conso_progression_chart"></div>
    </div>

    <div class="fr-notice bg-white fr-mt-2w">
        <div class="fr-px-2w">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <span class="fr-icon-information-line" aria-hidden="true"></span>
                    <span class="fr-text--xs fr-mr-1w">Source de données: </span>
                    <p class="fr-tag fr-tag--sm fr-tag--blue">
                        <strong>FICHIERS FONCIERS</strong>
                    </p>
                    <p class="fr-tag fr-tag--sm fr-tag--blue">
                        <strong>INSEE</strong>
                    </p>
                </div>
                <button class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill mt-0" aria-expanded="false" aria-controls="target-data-population_conso_progression_chart">Détails données et calcul</button>
            </div>
            <div class="fr-collapse" id="target-data-population_conso_progression_chart">
                <h6 class="fr-mt-2w">Source</h6>
                {% include "project/components/widgets/source_majic.html" %}
                {% include "project/components/widgets/source_insee.html" %}
                <h6 class="fr-mt-2w">Calcul</h6>
                <p class="fr-text--sm">Données brutes, sans calcul</p>
                <p class="fr-text--sm">Évolution estimée = (somme des évolutions annuelles de la population) / (nombre d'années)</p>

                <h6 class="fr-mt-2w">Données</h6>
                {{ population_progression_table }}
            </div>
        </div>
    </div>
</div>

<div class="fr-mt-7w" id="territoires-de-comparaison">
    <h3>Comparaison avec les territoires similaires</h3>

    <div class="fr-callout bg-white">
        <p class="fr-callout__text fr-text--sm">
            Par défaut, les territoires de comparaison incluent les territoires voisins. Vous pouvez en retirer ou en ajouter selon vos besoins.
        </p>
        {% if project.look_a_like %}
            <ul class="fr-tags-group fr-mt-2w">
                {% for land in project.get_look_a_like %}
                    <li>
                        <form 
                            hx-post="{% url 'project:rm-lookalike' project.id %}"
                            hx-ext="disable-element" 
                            hx-disable-element="#land_{{ land.name|slugify }}"
                        >
                            {% csrf_token %}
                            <input type="hidden" name="public_key" value="{{ land.public_key }}">
                            <button type="submit" class="fr-tag fr-tag--sm fr-icon-close-line fr-tag--icon-left" aria-describedby="tooltip-{{ land.name|slugify }}" aria-label="Retirer le territoire {{ land.name }}" id="land_{{ land.name|slugify }}">{{ land.name }}</button>
                            <span class="fr-tooltip fr-placement" id="tooltip-{{ land.name|slugify }}" role="tooltip" aria-hidden="true">Retirer le territoire de comparaison {{ land.name }}</span>
                        </form>
                    </li>
                {% endfor %}
            </ul>
        {% else %}
            <p class="text-muted fr-text--sm fr-mt-1w">Il n'y a aucun territoire de comparaison de configuré.</p>
        {% endif %}
        <button 
            class="fr-btn fr-btn--sm fr-btn--icon-left fr-icon-add-circle-line fr-mt-1w"
            data-toggle="tooltip"
            data-fr-opened="false" 
            aria-controls="fr-modal-3" 
            title="Ajouter un territoire de comparaison" 
            hx-get="{% url 'project:lookalike' project.id %}"
            hx-target="#add_lookalike_form"
        >
            Ajouter un territoire de comparaison
        </button>
    </div>

    <div class="bg-white fr-p-2w">
        <div class="d-flex justify-content-end align-items-center fr-mb-2w">
            {% include "project/components/widgets/chart_buttons.html" with chart="population_conso_comparison_chart" show_fullscreen=True %}
            <button class="fr-btn fr-icon-question-line fr-btn--tertiary fr-btn--sm" data-bs-toggle="modal" data-bs-target="#populationConsoComparisonModal" data-toggle="tooltip" title="Astuces pour lire le graphique"></button>
        </div>
        <div id="population_conso_comparison_chart"></div>
    </div>

    <div class="fr-notice bg-white fr-mt-2w">
        <div class="fr-px-2w">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <span class="fr-icon-information-line" aria-hidden="true"></span>
                    <span class="fr-text--xs fr-mr-1w">Source de données: </span>
                    <p class="fr-tag fr-tag--sm fr-tag--blue">
                        <strong>FICHIERS FONCIERS</strong>
                    </p>
                    <p class="fr-tag fr-tag--sm fr-tag--blue">
                        <strong>INSEE</strong>
                    </p>
                </div>
                <button class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill mt-0" aria-expanded="false" aria-controls="target-data-population_conso_comparison_chart">Détails données et calcul</button>
            </div>
            <div class="fr-collapse" id="target-data-population_conso_comparison_chart">
                <h6 class="fr-mt-2w">Source</h6>
                {% include "project/components/widgets/source_majic.html" %}
                {% include "project/components/widgets/source_insee.html" %}
                <h6 class="fr-mt-2w">Calcul</h6>
                <p class="fr-text--sm">Données brutes, sans calcul</p>

                <h6 class="fr-mt-2w">Données</h6>
                {{ population_comparison_table }}
            </div>
        </div>
    </div>
</div>

<div class="fr-mt-7w">
    <div class="bg-white fr-p-2w">
        <div class="d-flex justify-content-end align-items-center fr-mb-2w">
            {% include "project/components/widgets/chart_buttons.html" with chart="surface_proportional_chart" show_fullscreen=True %}
            <button class="fr-btn fr-icon-question-line fr-btn--tertiary fr-btn--sm" data-bs-toggle="modal" data-bs-target="#consoRelativeSurface" data-toggle="tooltip" title="Astuces pour lire le graphique"></button>
        </div>
        <div id="surface_proportional_chart"></div>
    </div>
    
    <div class="fr-notice bg-white fr-mt-2w">
        <div class="fr-px-2w">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <span class="fr-icon-information-line" aria-hidden="true"></span>
                    <span class="fr-text--xs fr-mr-1w">Source de données: </span>
                    <p class="fr-tag fr-tag--sm fr-tag--blue">
                        <strong>FICHIERS FONCIERS</strong>
                    </p>
                </div>
                <button class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill mt-0" aria-expanded="false" aria-controls="surface-relative-comparison-data">Détails données et calcul</button>
            </div>
            <div class="fr-collapse" id="surface-relative-comparison-data">
                <h6 class="fr-mt-2w">Source</h6>
                {% include "project/components/widgets/source_majic.html" %}  
                <h6 class="fr-mt-2w">Calcul</h6>
                <p class="fr-text--sm">
                    Pour chaque territoire, la consommation d'espace annuelle est multipliée par 1000 et divisée par
                    sa surface totale. Le résultat est exprimé en pour mille (‰).
                </p>
        
                <h6 class="fr-mt-2w">Données</h6>
                {{ surface_proportional_data_table }}
            </div>
        </div>
    </div>
</div>

<div class="fr-mt-7w">
    <div class="bg-white fr-p-2w">
        <div class="d-flex justify-content-end align-items-center fr-mb-2w">
            {% include "project/components/widgets/chart_buttons.html" with chart="comparison_chart" show_fullscreen=True %}
            <button class="fr-btn fr-icon-question-line fr-btn--tertiary fr-btn--sm" data-bs-toggle="modal" data-bs-target="#comparaisonVoisin" data-toggle="tooltip" title="Astuces pour lire le graphique"></button>
        </div>
        <div id="comparison_chart"></div>
    </div>

    <div class="fr-notice bg-white fr-mt-2w">
        <div class="fr-px-2w">
            <div class="d-flex align-items-center justify-content-between">
                <div>
                    <span class="fr-icon-information-line" aria-hidden="true"></span>
                    <span class="fr-text--xs fr-mr-1w">Source de données: </span>
                    <p class="fr-tag fr-tag--sm fr-tag--blue">
                        <strong>FICHIERS FONCIERS</strong>
                    </p>
                </div>
                <button class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill mt-0" aria-expanded="false" aria-controls="target-data-2">Détails données et calcul</button>
            </div>
            <div class="fr-collapse" id="target-data-2">
                <h6 class="fr-mt-2w">Source</h6>
                {% include "project/components/widgets/source_majic.html" %}
                <h6 class="fr-mt-2w">Calcul</h6>
                <p class="fr-text--sm">Données brutes, sans calcul</p>

                <h6 class="fr-mt-2w">Données</h6>
                {{ comparison_table }}
            </div>
        </div>
    </div>

</div>

<!-- Modal -->
<div class="modal fade" id="consoAnnuelle" tabindex="-1" aria-labelledby="consoAnnuelleLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="fr-modal__body">
            <div class="fr-modal__header">
                <button class="fr-link--close fr-link" data-bs-dismiss="modal" aria-label="Close">Fermer</button>
            </div>
            <div class="fr-modal__content">
                <h1 class="fr-modal__title" id="consoAnnuelleLabel">
                    <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                    Astuces Graphique - Consommation d'espaces annuelle sur le territoire
                </h1>
                {% include "project/components/widgets/chart_tips_buttons.html" %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="determinantModal" tabindex="-1" aria-labelledby="determinantLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="fr-modal__body">
            <div class="fr-modal__header">
                <button class="fr-link--close fr-link" data-bs-dismiss="modal" aria-label="Close">Fermer</button>
            </div>
            <div class="fr-modal__content">
                <h1 class="fr-modal__title" id="determinantLabel">
                    <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                    Astuces Graphique - Destinations de la consommation
                </h1>
                <p class="fr-text--sm">
                    Les destinations indiquent les natures de la consommation de l’espace NAF (Naturel, Agricole et Forestier).
                    Ils sont définis en 6 catégories par le Cerema : habitat, activité, mixte (lorsqu'il y a un mélange d'habitat et d'activité,
                    par exemple un commerce au rez de chaussée et des logements aux étages), route, ferré, inconnu (lorsque les fichiers
                    fonciers ne permettent pas de préciser la destination).
                </p>
                {% include "project/components/widgets/chart_tips_legend.html" %}
                {% include "project/components/widgets/chart_tips_buttons.html" %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="densityModal" tabindex="-1" aria-labelledby="densityLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="fr-modal__body">
            <div class="fr-modal__header">
                <button class="fr-link--close fr-link" data-bs-dismiss="modal" aria-label="Close">Fermer</button>
            </div>
            <div class="fr-modal__content">
                <h1 class="fr-modal__title" id="densityLabel">
                    <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                    Astuces Graphique - {{ population_density_chart.chart.title.text }}
                </h1>
                <p class="fr-text--sm">
                    La densité de population est le rapport entre l’effectif de population du territoire et sa superficie. Par souci de cohérence avec le reste des indicateurs, nous avons choisi de l’exprimer en habitants par hectare.
                </p>
                {% include "project/components/widgets/chart_tips_buttons.html" %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="populationConsoProgressionModal" tabindex="-1" aria-labelledby="populationConsoProgressionLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="fr-modal__body">
            <div class="fr-modal__header">
                <button class="fr-link--close fr-link" data-bs-dismiss="modal" aria-label="Close">Fermer</button>
            </div>
            <div class="fr-modal__content">
                <h1 class="fr-modal__title" id="populationConsoProgressionLabel">
                    <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                    Astuces Graphique - {{ population_conso_progression_chart.chart.title.text }}
                </h1>
                <p class="fr-text--sm">
                    Pour ce qui concerne les données de population, il est important de noter que l’INSEE indique que "les résultats des recensements depuis 2006 ne se comparent correctement entre eux que sur des périodes espacées d'au moins 5 ans".
                    Les données annuelles de population affichées sur le graphe ne sont donc pas comparables d’une année sur l'autre pour mesurer précisément l'évolution de la population.
                </p>
                {% include "project/components/widgets/chart_tips_legend.html" %}
                {% include "project/components/widgets/chart_tips_buttons.html" %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="populationConsoComparisonModal" tabindex="-1" aria-labelledby="populationConsoComparisonLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="fr-modal__body">
            <div class="fr-modal__header">
                <button class="fr-link--close fr-link" data-bs-dismiss="modal" aria-label="Close">Fermer</button>
            </div>
            <div class="fr-modal__content">
                <h1 class="fr-modal__title" id="populationConsoComparisonLabel">
                    <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                    Astuces Graphique - {{ population_conso_comparison_chart.chart.title.text }}
                </h1>
                <p class="fr-text--sm">
                    Ce graphique permet de mettre en relation la consommation d’espaces des territoires et leur évolution démographique sur une période donnée ainsi que de visualiser sa population totale grâce à la taille des bulles.
                </p>
                {% include "project/components/widgets/chart_tips_comparison.html" %}
                {% include "project/components/widgets/chart_tips_legend.html" %}
                {% include "project/components/widgets/chart_tips_buttons.html" %}
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="consoRelativeSurface" tabindex="-1" aria-labelledby="consoRelativeSurfaceLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="fr-modal__body">
            <div class="fr-modal__header">
                <button class="fr-link--close fr-link" data-bs-dismiss="modal" aria-label="Close">Fermer</button>
            </div>
            <div class="fr-modal__content">
                <h1 class="fr-modal__title" id="consoRelativeSurfaceLabel">
                    <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                    Astuces Graphique - {{ surface_proportional_chart.chart.title.text }}
                </h1>
                <p class="fr-text--sm">
                    La consommation proportionnelle à la surface des territoires permet d'analyser la consommation d'espaces au regard de la surface totale du territoire.
                    Cette approche permet de comparer les territoires selon le pourcentage d'ha consommé par rapport au volume d'ha total du territoire.
                    La comparaison avec les territoires similaires permet d'appréhender les dynamiques globales brutes de consommation d'espaces NAF (Naturels, Agricoles et Forestiers) et de les comparer entre elles.
                </p>
                {% include "project/components/widgets/chart_tips_comparison.html" %}
                {% include "project/components/widgets/chart_tips_legend.html" %}
                {% include "project/components/widgets/chart_tips_buttons.html" %}
            </div>
        </div>
    </div>
</div>

<div class="modal fade" id="comparaisonVoisin" tabindex="-1" aria-labelledby="comparaisonVoisinLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="fr-modal__body">
            <div class="fr-modal__header">
                <button class="fr-link--close fr-link" data-bs-dismiss="modal" aria-label="Close">Fermer</button>
            </div>
            <div class="fr-modal__content">
                <h1 class="fr-modal__title" id="comparaisonVoisinLabel">
                    <span class="fr-fi-arrow-right-line fr-fi--lg"></span>
                    Astuces Graphique - {{ comparison_chart.chart.title.text }}
                </h1>
                <p class="fr-text--sm">
                    La comparaison avec les territoires similaires permet d'appréhender les dynamiques globales brutes de consommation d'espaces NAF (Naturels, Agricoles et Forestiers) et de les comparer entre elles.
                    Par défaut, Mon Diagnostic Artificialisation vous permet de comparer votre territoire avec les territoires similaires de même niveau administratif, à l'exception des territoires insulaires (notamment les DROM-COM) pour lesquelles une comparaison avec d'autres territoires similaires est proposée.
                </p>
                {% include "project/components/widgets/chart_tips_comparison.html" %}
                {% include "project/components/widgets/chart_tips_legend.html" %}
                {% include "project/components/widgets/chart_tips_buttons.html" %}
            </div>
        </div>
    </div>
</div>

<!-- Modal -->
<dialog aria-labelledby="fr-modal-title-modal-3" id="fr-modal-3" class="fr-modal">
    <div class="fr-container fr-container--fluid fr-container-md">
        <div class="fr-grid-row fr-grid-row--center">
            <div class="fr-col-12 fr-col-md-8 fr-col-lg-6">
                <div class="fr-modal__body">
                    <div class="fr-modal__header">
                        <button class="fr-btn--close fr-btn" title="Fermer la fenêtre modale" aria-controls="fr-modal-3">Fermer</button>
                    </div>
                    <div class="fr-modal__content">
                        <h1 id="fr-modal-title-modal-1" class="fr-modal__title">Ajouter un territoire de comparaison</h1>
                        <div id="add_lookalike_form">
                            <div class="fr-custom-loader"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</dialog>

{% display_chart_data 'annual_total_conso_chart' annual_total_conso_chart CSP_NONCE %}
{% display_chart_data 'comparison_chart' comparison_chart CSP_NONCE %}
{% display_chart_data 'chart_determinant' determinant_per_year_chart CSP_NONCE %}
{% display_chart_data 'pie_determinant' determinant_pie_chart CSP_NONCE %}
{% display_chart_data 'surface_proportional_chart' surface_proportional_chart CSP_NONCE %}
{% display_chart_data 'population_density_chart' population_density_chart CSP_NONCE %}
{% display_chart_data 'population_conso_progression_chart' population_conso_progression_chart CSP_NONCE %}
{% display_chart_data 'population_conso_comparison_chart' population_conso_comparison_chart CSP_NONCE %}
