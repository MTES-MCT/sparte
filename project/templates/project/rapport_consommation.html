{% extends 'index.html' %}

{% load static %}
{% load project_tags %}
{% load humanize %}
{% load i18n %}
{% load l10n %}
{% load highcharts_tags %}

{% block pagetitle %}
Rapport consommation
{% endblock %}

{% block headers %}
<link href="{% static 'project/css/project.css' %}" rel="stylesheet" nonce="{{ CSP_NONCE }}" />
<style nonce="{{ CSP_NONCE }}">
.plotband_blue{
    fill: rgba(149, 206, 255, 0.1);
    color: rgb(149, 206, 255);
}

.plotband_green{
    fill: rgba(169, 255, 150, 0.1);
    color: rgb(135, 204, 120);
}

.plotband_orange{
    fill: rgba(255, 188, 117, 0.1);
    color: rgb(255, 188, 117);
}

.plotband_pink{
    fill: rgba(255, 117, 153, 0.1);
    color: rgb(255, 117, 153);
}

.plotband_violet{
    fill: rgba(153, 158, 255, 0.1);
    color: rgb(153, 158, 255);
}

.plotband_gray {
    fill: rgba(92, 92, 97, 0.1);
    color: rgb(92, 92, 97);

}
</style>
{% endblock %}

{% block content %}
    <div class="px-4">
        {% include "project/detail_menu.html" %}

        <div class="bg-light p-5 rounded-5 border">

            <div class="box box-alert px-4 py-2 mb-4 mt-0">
                <p>La loi Climat & Résilience recommande d'ici 2031 de diviser par 2 la consommation d'espace par rapport au bilan 2011-2021.</p>
                <p>Pour comprendre la dynamique sur le territoire sélectionné, cette page propose les indicateurs suivants :</p>
                <ul>
                    <li>projection 2031 selon la trajectoire ZAN,</li>
                    <li>consommation annuelle du territoire,</li>
                    <li>comparaison du territoire avec les territoires voisins,</li>
                    <li>évolution de la surface consommée sur la période,</li>
                    <li>déterminants de sa consommation d'espace.</li>
                </ul>
            </div>

            <div class="clearfix">
                <div class="card key-figure">
                    <div class="card-body">
                        <p class="figure">{{ total_surface|floatformat:0 }} ha</p>
                    </div>
                    <div class="card-header">
                        Surface du territoire
                    </div>
                </div>

                <div class="card key-figure key-figure-yellow">
                    <div class="card-body">
                        <p class="figure">+{{ project_scope.consummed|floatformat:1 }} ha</p>
                    </div>
                    <div class="card-header">
                        Consommation {{ project.analyse_start_date }} à {{ project.analyse_end_date }}
                    </div>
                </div>
            </div>

            <div class="clearfix">
                <div class="card key-figure key-figure-green">

                    <div class="card-body">
                        <p class="figure">+{{ objective_chart.total_real|floatformat:1 }} ha</p>
                    </div>
                    <div class="card-header">
                        Consommation 2011-2020 <i class="bi bi-question-circle" data-toggle="tooltip" title="Données prévisionelles pour 2020"></i>
                    </div>
                </div>

                <div class="card key-figure key-figure-green">
                    <div class="card-body">
                        <p class="figure">+{{ objective_chart.conso_2031|floatformat:1 }} ha</p>
                    </div>
                    <div class="card-header">
                        Trajectoire 2021-2030 <i class="bi bi-question-circle" data-toggle="tooltip" title="Réduction de 50% par rapport à la décennie précédente"></i>
                    </div>
                </div>

                <div class="card key-figure key-figure-green">

                    <div class="card-body">
                        <p class="figure">+{{ objective_chart.annual_objective_2031|floatformat:1 }} ha/an</p>
                    </div>
                    <div class="card-header">
                        Trajectoire projetée annualisée
                    </div>
                </div>
            </div>

            <div class="w-100 box p-4">
                <h3>
                    Projection 2031 selon la trajectoire ZAN
                </h3>

                <div id="objective_chart" class=""></div>

                <p class="my-0">
                    <strong>En <span class="plotband_blue">bleu</span> : période de référence</strong>
                </p>
                <p class="my-0">
                    <span class="text-muted"><em>1er jan. 2011 - 31 déc. 2020, 10 ans</em></span>
                </p>
                <p class="my-0">
                    L'ensemble des données officielles n'étant pas encore disponible, l'année 2020 est une consommation prévisionnelle (en gris dans le graphique). La consommation prévisionnelle est la moyenne de la consommation réelle (en bleu).
                </p>
                <p class="mt-2 mb-4">
                    Consommation cumulée de référence (réelle + prévisionnelle) : {{ objective_chart.total_real|floatformat:1 }} ha
                    <br/>Consommation annuelle de référence : {{ objective_chart.previsionnal|floatformat:1 }} ha
                </p>

                <p class="my-0">
                    <strong>En <span class="plotband_green">vert</span> : réduction de 50% </strong>
                <p class="my-0">
                    <span class="text-muted"><em>1er jan. 2021 - 31 déc. 2030, 10 ans</em></span>
                </p>
                <p class="my-0">
                    Pendant la période de réduction, la loi prévoit que le territoire ne consomme que 50% de ce qui a été consommé pendant la période de référence. Par conséquent, la consommation cumulée du 1er janvier 2021 au 31 décembre 2030 doit être égale à la consommation du 1er janvier 2011 au 31 décembre 2020 divisée par 2.
                </p>
                <p class="mt-2 mb-4">
                    Objectif de consommation cumulée 2030 : {{ objective_chart.conso_2031|floatformat:1 }} ha
                    <br/>Consommation annuelle moyenne : {{ objective_chart.annual_objective_2031|floatformat:1 }} ha
                </p>
            </div>


            <div class="w-100 box p-4">
                <h3 class="clearfix">
                    <div class="float-end">
                        <div class="btn-group">
                            <div class="dropdown me-2">
                                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton2" data-bs-toggle="dropdown" aria-expanded="false">
                                    Maille d'analyse
                                </button>
                                <ul class="dropdown-menu mt-2" aria-labelledby="dropdownMenuButton2">
                                    <li><a class="dropdown-item {% if level == "COMM" %}active{% endif %}" href="{% url "project:report_conso" project.id %}?level_conso=COMMUNE">Communes</a></li>
                                    {% if land_type in "DEPART_REGION_COMP" %}
                                    <li><a class="dropdown-item {% if level == "EPCI" %}active{% endif %}" href="{% url "project:report_conso" project.id %}?level_conso=EPCI">EPCI</a></li>
                                    {% endif %}
                                    {% if land_type in "REGION_COMP" %}
                                    <li><a class="dropdown-item {% if level == "DEPART" %}active{% endif %} " href="{% url "project:report_conso" project.id %}?level_conso=DEPART">Départements</a></li>
                                    {% endif %}
                                    {% if land_type in "COMP" %}
                                    <li><a class="dropdown-item {% if level == "REGION" %}active{% endif %}" href="{% url "project:report_conso" project.id %}?level_conso=REGION">Régions</a></li>
                                    {% endif %}
                                </ul>
                            </div>

                            <div class="dropdown">
                                <button class="btn btn-primary btn-sm dropdown-toggle" type="button" id="dropdownMenuButton1" data-bs-toggle="dropdown" aria-expanded="false">
                                    Sélection
                                </button>
                                <ul class="dropdown-menu mt-2" aria-labelledby="dropdownMenuButton1">
                                    <li><a id="check" class="dropdown-item" href="#" chart_target="chart">Tout</a></li>
                                    <li><a id="uncheck" class="dropdown-item" href="#" chart_target="chart">Aucun</a></li>
                                    <li><a id="reverse" class="dropdown-item" href="#" chart_target="chart">Inverser</a></li>
                                    <li><hr class="dropdown-divider"></li>
                                    <li><h6 class="dropdown-header">Zoom sur un groupe de villes</h6></li>
                                    {% for name in groups_names %}
                                        <li><a class="dropdown-item" href="{% url 'project:report_city_group' project.id %}?group_name={{ name }}">{{ name }}</a></li>
                                    {% endfor %}
                                    <li><a class="dropdown-item" href="{% url 'project:report_city_group' project.id %}">Tous</a></li>
                                </ul>
                            </div>
                        </div>
                    </div>
                    Consommation annuelle des {% if level == "COMM" %}communes{% elif level == "EPCI" %}communes{% elif level == "DEPT" %}EPCI{% else %}départements{% endif %} du territoire
                </h3>

                <div id="chart" class="flex-fill"></div>
            </div>

            <div class="w-100 box p-4">
                <a name="territoires-de-comparaison"></a>
                <h3>
                    <a class="float-end"href="{% url 'project:lookalike' project.id %}?from=conso_report">
                        <i class="bi bi-plus-circle" data-toggle="tooltip" title="Ajouter un territoire de comparaison"></i>
                    </a>
                    Comparaison avec les territoires voisins
                </h3>
                <div class="clearfix">
                    <div class="form-check form-switch float-end">
                        <label class="form-check-label" for="flexSwitchCheckDefault">Pondérer par la surface</label>
                        <input class="form-check-input" type="checkbox" id="conso_territory_reltive" {% if relative %}CHECKED{% endif %}>
                    </div>
                </div>
                <div id="chart_2" class="flex-fill"></div>
            </div>

            <div class="box scrollme-x p-4">
                <h3 class="mb-3">Surface consommée (en ha) :</h3>
                <table class="table table-striped table-sm table-borderless">
                    <thead>
                        <tr>
                            <th scope="col">{{ col_name }}</th>
                            {% for year in project.years %}
                            <th scope="col" class="text-end">{{ year }}</th>
                            {% endfor %}
                            <th scope="col" class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for city_name, data in communes_data_table.items %}
                        <tr>
                            <th scope="row">{{ city_name }}</th>
                            {% for year, val in data.items %}
                            <td align="right">+{{ val|floatformat:1 }}</td>
                            {% endfor %}
                        </tr>
                        {% endfor %}
                    </tbody>
                </table>
            </div>


            <div class="w-100 box p-4">
                <h3>Déterminants de la consommation</h3>
                <div class="row">
                    <div class="col-4 border-end">
                        <div id="pie_determinant"></div>
                    </div>
                    <div class="col-8">
                        <div id="chart_determinant"></div>
                    </div>
                </div>
            </div>

            <div class="box scrollme-x p-4">
                <h3 class="mb-3">Déterminants de la consommation :</h3>
                <table class="table table-striped table-sm table-borderless">
                    <thead>
                        <tr>
                            <th scope="col">Déterminant</th>
                            {% for year in project.years %}
                            <th scope="col" class="text-end">{{ year }}</th>
                            {% endfor %}
                            <th scope="col" class="text-end">Total</th>
                        </tr>
                    </thead>
                    <tbody>
                        {% for determinant_name, data in data_determinant.items %}
                        <tr>
                            <th scope="row">{{ determinant_name }}</th>
                            {% for year, val in data.items %}
                            <td align="right">+{{ val|floatformat:1 }}</td>
                            {% endfor %}
                        </tr>

                        {% endfor %}
                    </tbody>
                </table>
            </div>



            <div class="box alert">
                <h3>Provenance des données</h3>
                La consommation d’espace est mesurée avec les fichiers fonciers qui font une description cadastrale du territoire.
            </div>
        </div>
    </div>

{% endblock %}

{% block bodyend %}
{% localize off %}
<script src="https://code.highcharts.com/highcharts.js" nonce="{{ CSP_NONCE }}"></script>
<script src="https://code.highcharts.com/modules/exporting.js" nonce="{{ CSP_NONCE }}"></script>
{% french_translation %}
{% display_chart 'chart' commune_chart CSP_NONCE %}
{% display_chart 'chart_2' comparison_chart CSP_NONCE %}
{% display_chart 'chart_determinant' determinant_per_year_chart CSP_NONCE %}
{% display_chart 'pie_determinant' determinant_pie_chart CSP_NONCE %}
{% display_chart 'objective_chart' objective_chart CSP_NONCE %}
<script language="javascript" nonce="{{ CSP_NONCE }}">
///////////////////////////////
// Select / unselect all
///////////////////////////////

$('#check').click(function(){
    let div_id = $(this).attr('chart_target');
    let chart = $("#" + div_id).highcharts();
    $(chart.series).each(function(){
        this.setVisible(true, false)
    })
    chart.redraw()
})

$('#uncheck').click(function(){
    let div_id = $(this).attr('chart_target')
    let chart = $("#" + div_id).highcharts()
    //chart.series.forEach(serie => serie.hide())
    $(chart.series).each(function(){
        this.setVisible(false, false)
    })
    chart.redraw()
})

$('#reverse').click(function(){
    let div_id = $(this).attr('chart_target');
    let chart = $("#" + div_id).highcharts();
    $(chart.series).each(function(){
        if (this.visible){
            this.setVisible(false, false)
        }else{
            this.setVisible(true, false)
        }
    })
    chart.redraw()
})

$('#conso_territory_reltive').change(function() {
    url = '{% url "project:report_conso" project.id %}?relative=' + this.checked
    url = url + '#territoires-de-comparaison'
    window.location.replace(url)
})
</script>

{% endlocalize %}
{% endblock %}
