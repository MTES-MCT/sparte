{% extends "index.html" %}

{% load static %}
{% load project_tags %}
{% load humanize %}
{% load i18n %}
{% load l10n %}
{% load highcharts_tags %}
{% load sri %}
{% load crispy_forms_tags %}

{% block pagetitle %}
Trajectoires
{% endblock pagetitle %}

{% block headers %}
<meta name="htmx-config" content='{"inlineScriptNonce":"{{ CSP_NONCE }}"}'>
{% localize off %}
{% sri_static "highcharts/js/highcharts.js" %}
{% sri_static "highcharts/js/exporting.js" %}
{% french_translation %}
{% endlocalize %}
{% endblock headers %}

{% block content %}
<div class="px-4">
    {% include "project/partials/report_title.html" with title=diagnostic surface=diagnostic.area %}

    {% include "project/report_menu.html" %}

    <div class="fr-container fr-py-3w">
        <div class="fr-alert fr-alert--info">
            <div class="fr-alert__title">Comment fonctionne cet écran ?</div>
            <p class="fr-text--sm">
                Cet écran vous permet de visualiser votre trajectoire en renseignant vos consommations d'espaces prévisionnelles année par année (en Ha).
                <br/>Pour commencer, veuillez sélectionner une période, puis saisissez les surfaces consommées prévisionnelles pour chaque année.
            </p>
        </div>

        <div class="fr-grid-row fr-grid-row--gutters fr-mt-7w">

            <div class="fr-col-12 fr-col-md-4 fr-grid-row">
                <div class="fr-callout w-100">
                    <h3>Période de référence</h3>
                    <p class="fr-callout__title">{{ total_real|floatformat:0 }} ha ({{ annual_real|floatformat:1 }} ha/an)</p>
                    <p>Consommation cumulée de la période du 1er jan. 2011 au 31 déc. 2020 (10 ans)</p>
                </div>
            </div>

            <div class="fr-col-12 fr-col-md-4 fr-grid-row">
                <div class="fr-callout w-100">
                    <h3>Projection 2031</h3>
                    <p class="fr-callout__title">{{ conso_2031|floatformat:1 }} ha ({{ annual_objective_2031|floatformat:1 }} ha/an)</p>
                    <p>Consommation cumulée de la période du 1er jan. 2021 au 31 déc. 2030 (10 ans) avec un seuil de réduction de 50%</p>
                    <p><button id="btn-change-objective" class="fr-btn fr-btn--primary fr-btn--sm" data-bs-toggle="modal" data-bs-target="#setTarget" data-toggle="tooltip" title="Personnaliser mon objectif 2031" aria-hidden="true" hx-get="{% url 'project:set_target_2031' project.pk %}" hx-target="#setTargetForm">Personnaliser mon seuil de réduction:&nbsp;<span id="button-swapper">{{ diagnostic.target_2031 }}</span>%</button></p>
                </div>
            </div>

            <div class="fr-col-12 fr-col-md-4 fr-grid-row">
                <div class="fr-callout w-100">
                    <h3>Projection personnalisée</h3>
                    {% if trajectory %}
                        <p class="fr-callout__title">+{{ conso_perso|floatformat:1 }} ha ({{ annual_perso|floatformat:1 }} ha/an)</p>
                        <p>Consommation cumulée de la période du 1er jan. 2021 au 31 déc. {{ trajectory.end }}</p>
                        <p><button class="fr-btn fr-btn--primary fr-btn--sm">Configurer ma projection personnalisée</button></p>
                    {% else %}
                        <p><button class="fr-btn fr-btn--primary fr-btn--sm">CTA spéciale: Configurer ma projection personnalisée pour la première fois</button></p>
                    {% endif %}
                    
                </div>
            </div>

        </div>

        <div id="graphic" class="fr-mt-7w" hx-get="{% url 'project:trajectory:partial-graphic' diagnostic.id %}" hx-trigger="load-graphic from:body">
            {% include "trajectory/partials/graphic.html" %}
        </div>

        <div id="update-form" class="fr-mt-7w">
            <button class="fr-btn" hx-target="#update-form" hx-get="{% url 'project:trajectory:partial-form-consumption' diagnostic.id %}">Show form</button>
        </div>

    </div>
</div>

<!-- Modal -->
<div class="modal fade" id="setTarget" tabindex="-1" aria-labelledby="setTargetLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="fr-modal__body">
            <div class="fr-modal__header">
                <button class="fr-link--close fr-link" data-bs-dismiss="modal" aria-label="Close">Fermer</button>
            </div>
            <div class="fr-modal__content">
                <h1 class="fr-modal__title" id="setTargetLabel">
                    Personnaliser mon objectif 2031
                </h1>
                <div id="setTargetForm">
                    <div class="fr-custom-loader"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% endblock content %}

{% block bodyend %}

<script language="javascript" nonce="{{ CSP_NONCE }}">
    window.htmx.on("hidden.bs.modal", () => {
        document.getElementById("setTrajectoryForm").innerHTML = "<div class='fr-custom-loader'></div>"
    })

    window.htmx.on("htmx:oobAfterSwap", (e) => {
        // Check swap target
        if (e.detail.target.id === "conso-input-swapper") {
            const modal = bootstrap.Modal.getInstance(document.getElementById("setTrajectory"))
            if (modal) {
                modal.hide()
                // Wait for oob swap
                setTimeout(() => {
                    const formContainer = document.getElementById("conso-input-swapper")
                    const firstInput = formContainer.getElementsByClassName('fr-input')[0]
                    firstInput.focus()
                }, 500)
            }
        }
        else if (e.detail.target.id === "trajectory-chart-swapper") {
            // Wait for oob swap
            setTimeout(() => {
                const chartContainer = document.getElementById("trajectory-chart-swapper")
                const topPos = chartContainer.getBoundingClientRect().top + window.pageYOffset
                window.scrollTo({
                    top: topPos,
                    behavior: 'smooth'
                })
            }, 500)
        }
    })
</script>
{% endblock bodyend %}

{% block tagging %}
<script language="javascript" nonce="{{ CSP_NONCE }}">
$( window ).on('load', function () {
    _paq.push(['trackEvent', '', '', 'open_dashboard_trajectory'])
})

var fired = false
$( window ).scroll(function() {
    if(fired == false && $( window ).scrollTop() + $( window ).height() > $( "#block-content" ).height() - 100) {
        _paq.push(['trackEvent', '', '', 'end_dashboard_trajectory'])
        fired = true
    }
})
</script>
{% endblock tagging %}
