{% load highcharts_tags %}

{% comment %} <button class="fr-btn" hx-target="#graphic" hx-get="{% url 'project:trajectory:partial-graphic' diagnostic.id %}">reload</button> {% endcomment %}

<div class="fr-mt-7w">
    <div class="border fr-p-2w">
        <div class="d-flex justify-content-end align-items-center fr-mb-2w">
            <div class="dropdown custom-dropdown fr-mr-2w" data-toggle="tooltip" title="Exporter le graphique">
                <button class="fr-btn fr-icon-download-line fr-btn--tertiary fr-btn--sm" data-bs-toggle="dropdown" aria-expanded="false"></button>

                <ul class="dropdown-menu">
                    <li>
                        <a class="fr-nav__link export-chart" href="#" data-chart-target="objective_chart" data-type="image/png">PNG</a>
                    </li>
                    <li>
                        <a class="fr-nav__link export-chart" href="#" data-chart-target="objective_chart" data-type="image/jpeg">JPEG</a>
                    </li>
                    <li>
                        <a class="fr-nav__link export-chart" href="#" data-chart-target="objective_chart" data-type="application/pdf">PDF</a>
                    </li>
                    <li>
                        <a class="fr-nav__link export-chart" href="#" data-chart-target="objective_chart" data-type="image/svg+xml">Vectoriel</a>
                    </li>
                </ul>
            </div>

            <button class="fr-btn fr-icon-drag-move-2-line fr-btn--tertiary fr-btn--sm fullscreen-chart" data-chart-target="trajectory_chart" data-toggle="tooltip" title="Afficher le graphique en plein écran"></button>
        </div>

        <div id="trajectory_chart"></div>
    </div>
</div>

<div class="fr-callout bg-white fr-p-2w mt-4">
    <button class="fr-btn fr-btn--secondary fr-btn--sm fr-btn--icon-right fr-icon-arrow-down-s-fill mt-0" aria-expanded="false" aria-controls="target-data-1">Données</button>
    <div class="fr-collapse" id="target-data-1">
        <h6 class="fr-mt-2w">Source</h6>
        <p>Fichiers fonciers du Cérema issus des données MAJIC  (Mise A Jour de l'Information Cadastrale) de la DGFIP (millésime min :  2009, millésime max : 2021)</p>

        <h6 class="fr-mt-2w">Calcul</h6>
        <p>La consommation réelle annuelle et cumulée provient des données du Cérema. Elles donnent la consommation d'espaces NAF par année, pour le territoire choisi. </p>

        <h6 class="fr-mt-2w">Données</h6>
        
        <table class="table table-striped table-sm table-hover">
            <thead>
                <tr>
                    <th scope="col">Millésime</th>
                    <th scope="col" class="text-end">Réelle (Ha)</th>
                    <th scope="col" class="text-end">Réelle cumulée (Ha)</th>
                    <th scope="col" class="text-end">Projection annualisée<br/>de l'objectif 2031 (Ha)</th>
                    <th scope="col" class="text-end">Cumulé de la<br/>projection (Ha)</th>
                    <th scope="col" class="text-end">Trajectoire (Ha)</th>
                    <th scope="col" class="text-end">Cumulé de la<br/>trajectoire (Ha)</th>
                </tr>
            </thead>
            <tbody>
                {% for line in trajectory_chart.get_data_table %}
                <tr>
                    <th scope="row">{{ line.year }}</th>
                    <td align="right">{{ line.real|floatformat:1 }}</td>
                    <td align="right">{{ line.added_real|floatformat:1 }}</td>
                    <td align="right">{{ line.objective|floatformat:1 }}</td>
                    <td align="right">{{ line.added_objective|floatformat:1 }}</td>
                    <td align="right">{{ line.trajectory|floatformat:1 }}</td>
                    <td align="right">{{ line.added_trajectory|floatformat:1 }}</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>
</div>

<!-- Modal -->
<div class="modal fade modal-xl" id="setTrajectory" tabindex="-1" aria-labelledby="setTrajectoryLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-scrollable modal-dialog-centered">
        <div class="fr-modal__body">
            <div class="fr-modal__header">
                <button class="fr-link--close fr-link" data-bs-dismiss="modal" aria-label="Close">Fermer</button>
            </div>
            <div class="fr-modal__content">
                <h1 class="fr-modal__title" id="setTrajectoryLabel">
                    Configurer ma projection personnalisée
                </h1>
                <div id="setTrajectoryForm">
                    <div class="fr-custom-loader"></div>
                </div>
            </div>
        </div>
    </div>
</div>

{% display_chart 'trajectory_chart' trajectory_chart CSP_NONCE %}

{% if reload_kpi %}
    <span id="objective-swapper" hx-swap-oob="true">{{ diagnostic.target_2031 }}</span>
    <span id="total_real-swapper" hx-swap-oob="true">{{ total_real|floatformat:0 }}</span>
    <span id="annual_real-swapper" hx-swap-oob="true">{{ annual_real|floatformat:1 }}</span>
    <span id="conso_2031-swapper" hx-swap-oob="true">{{ conso_2031|floatformat:1 }}</span>
    <span id="annual_objective-swapper" hx-swap-oob="true">{{ annual_objective_2031|floatformat:1 }}</span>
    <span id="conso_perso-swapper" hx-swap-oob="true">{{ conso_perso|floatformat:1 }}</span>
    <span id="annual_perso-swapper" hx-swap-oob="true">{{ annual_perso|floatformat:1 }}</span>
{% endif %}
